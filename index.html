<!DOCTYPE HTML>

<html lang="en">
  
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="utf-8">
  
  <title>SPL Advanced Tricks</title>
  <meta name="author" content="Sergey Plashenko">
  
  <meta name="description" content="Personal blog about my findings and investigations in Sitecore and not only.">
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  
  <meta property="og:site_name" content="SPL Advanced Tricks">

  
    <meta property="og:image" content>
  

  
    <meta http-equiv="Content-Language" content="en">
  

  <link href="/img/favicon.png" rel="icon">
  
    <link rel="apple-touch-icon" href="/img/apple-icon.png">
    <link rel="apple-touch-icon-precomposed" href="/img/apple-icon.png">
    

  <link rel="alternate" href="/atom.xml" title="SPL Advanced Tricks" type="application/atom+xml">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
  
  <style type="text/css">
  /* Tim Pietrusky advanced checkbox hack (Android <= 4.1.2) */
body{ -webkit-animation: bugfix infinite 1s; }
@-webkit-keyframes bugfix { from {padding:0;} to {padding:0;} }

  

  
    article .post-content-index .entry{max-height: 550px; overflow:hidden;}
  
</style>

  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
  
  
  
  <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-144711500-1', 'auto');
  ga('send', 'pageview');
 
</script>



  
<link rel="stylesheet" href="/css/prism-vs.css" type="text/css"></head>
</html>

<body>
  <header id="header" class="inner"><div class="padding">
	<div class="alignleft logo">
	  <h1><a href="/">SPL Advanced Tricks</a></h1>
	</div>
	<nav id="main-nav" class="alignright">
		<input type="checkbox" id="toggle" />
		<label for="toggle" class="toggle" data-open="Main Menu" data-close="Close Menu" onclick><i class="fa fa-bars"></i></label>
	  <ul class="menu">
	    
	      <li><a href="/">Home</a></li>
	    
	      <li><a href="/archives">Archives</a></li>
	    
	    
	  </ul>
	</nav>
	<div class="clearfix"></div>
</div>
</header>
  <div id="page-heading-wrap">
    <div class="inner">
      <div class="padding">
        
          <h2>
            <script>
              document.getElementById("page-heading-wrap").style.padding = 0;
            </script>
          </h2>
        
      </div>
    </div>
  </div>
  <div id="content" class="inner">
    <div id="main-col" class="alignleft"><div id="wrapper" class="padding">
  <article class="post">
  
  
    <div class="post-content-index">
  
      
        <header>
          <!-- <div class="icon"></div> -->
            
    
      <h1 class="metro-title transition"><a href="/2019/09/07/SOLRQueryReplaying/">How to get the SOLR query generated by xConnect search and replay it</a></h1>
    
  
          <ul>
            <li>
              <span class="heading-span">Posted on: </span>
              <time datetime="2019-09-07T20:52:57.000Z">2019-09-07</time>
            </li>
            
              <li>
                <span class="heading-span">By: </span>

                
                  <a href="/">Sergey Plashenko</a>
                

              </li>
            
            <li>
              <!--span class="heading-span">With: </span-->
              
                <a href="/2019/09/07/SOLRQueryReplaying/#disqus_thread">Comments</a>

              
          </ul>
        </header>
      
      <div class="entry">
        
          
            <p>Sometimes there is a need to check what query is generated by xConnect search and passed to SOLR.</p>
<p>This article describes how the query can be found and replayed.</p>
<p>First of all, debug mode needs to be enabled in SOLR admin panel. It can be done as shown on the picture below:</p>
<p> <img src="/images/SOLRQueryReplaying/LoggingLevel_changed.png" alt></p>
<p>After this change, the executed queries will be written to the SOLR log. </p>
<p>Here is an example of such query:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">2019-09-06 09:05:44.148 DEBUG (qtp1330278544-196) [   x:sc901_xdb] o.a.s.s.s.LocalStatsCache ## GET &#123;q=(x_type_s:(ContactDataRecord)+AND+_query_:(&quot;\&#123;\!type%3Djoin+from%3Dcontactid_s+to%3Did\&#125;\(x_type_s\:\(InteractionDataRecord\)+AND+_query_\:\(\&quot;\\\&#123;\\\!type%3Dparent+which%3Dx_type_s\\\:\\\(InteractionDataRecord\\\)\\\&#125;\\\(path_s\\\:\\\(Events\\\)+AND+\\\(\\\(@odata.type_s\\\:\\\(#Sitecore.EmailCampaign.Model.XConnect.Events.UnsubscribedFromEmailEvent\\\)+OR+\\\(@odata.type_s\\\:\\\(#Sitecore.EmailCampaign.Model.XConnect.Events.SpamComplaintEvent\\\)+OR+\\\(@odata.type_s\\\:\\\(#Sitecore.EmailCampaign.Model.XConnect.Events.EmailSentEvent\\\)+OR+\\\(@odata.type_s\\\:\\\(#Sitecore.EmailCampaign.Model.XConnect.Events.EmailOpenedEvent\\\)+OR+\\\(@odata.type_s\\\:\\\(#Sitecore.EmailCampaign.Model.XConnect.Events.EmailClickedEvent\\\)+OR+\\\(@odata.type_s\\\:\\\(#Sitecore.EmailCampaign.Model.XConnect.Events.DispatchFailedEvent\\\)+OR+\\\(@odata.type_s\\\:\\\(#Sitecore.EmailCampaign.Model.XConnect.Events.BounceEvent\\\)+OR+@odata.type_s\\\:\\\(#Sitecore.EmailCampaign.Model.XConnect.Events.EmailEvent\\\)\\\)\\\)\\\)\\\)\\\)\\\)\\\)+AND+\\\(definitionid_s\\\:\\\(2a65acc5985140dd851b23f7a6c53092\\\)+AND+messageid_s\\\:\\\(c7b8358d3fea4138b2b15d457bf4d2b6\\\)\\\)\\\)\\\)\&quot;\)\)&quot;))&amp;df=_text_&amp;echoParams=explicit&amp;fl=id&amp;cursorMark=*&amp;json=&#123;&quot;query&quot;:&quot;(x_type_s:(ContactDataRecord)+AND+_query_:(\&quot;\\&#123;\\!type%3Djoin+from%3Dcontactid_s+to%3Did\\&#125;\\(x_type_s\\:\\(InteractionDataRecord\\)+AND+_query_\\:\\(\\\&quot;\\\\\\&#123;\\\\\\!type%3Dparent+which%3Dx_type_s\\\\\\:\\\\\\(InteractionDataRecord\\\\\\)\\\\\\&#125;\\\\\\(path_s\\\\\\:\\\\\\(Events\\\\\\)+AND+\\\\\\(\\\\\\(@odata.type_s\\\\\\:\\\\\\(#Sitecore.EmailCampaign.Model.XConnect.Events.UnsubscribedFromEmailEvent\\\\\\)+OR+\\\\\\(@odata.type_s\\\\\\:\\\\\\(#Sitecore.EmailCampaign.Model.XConnect.Events.SpamComplaintEvent\\\\\\)+OR+\\\\\\(@odata.type_s\\\\\\:\\\\\\(#Sitecore.EmailCampaign.Model.XConnect.Events.EmailSentEvent\\\\\\)+OR+\\\\\\(@odata.type_s\\\\\\:\\\\\\(#Sitecore.EmailCampaign.Model.XConnect.Events.EmailOpenedEvent\\\\\\)+OR+\\\\\\(@odata.type_s\\\\\\:\\\\\\(#Sitecore.EmailCampaign.Model.XConnect.Events.EmailClickedEvent\\\\\\)+OR+\\\\\\(@odata.type_s\\\\\\:\\\\\\(#Sitecore.EmailCampaign.Model.XConnect.Events.DispatchFailedEvent\\\\\\)+OR+\\\\\\(@odata.type_s\\\\\\:\\\\\\(#Sitecore.EmailCampaign.Model.XConnect.Events.BounceEvent\\\\\\)+OR+@odata.type_s\\\\\\:\\\\\\(#Sitecore.EmailCampaign.Model.XConnect.Events.EmailEvent\\\\\\)\\\\\\)\\\\\\)\\\\\\)\\\\\\)\\\\\\)\\\\\\)\\\\\\)+AND+\\\\\\(definitionid_s\\\\\\:\\\\\\(2a65acc5985140dd851b23f7a6c53092\\\\\\)+AND+messageid_s\\\\\\:\\\\\\(c7b8358d3fea4138b2b15d457bf4d2b6\\\\\\)\\\\\\)\\\\\\)\\\\\\)\\\&quot;\\)\\)\&quot;))&quot;,&quot;sort&quot;:&quot;id+asc&quot;&#125;&amp;sort=id+asc&amp;rows=0&amp;wt=json&#125;</span><br></pre></td></tr></table></figure>
<p>If you are lucky and the query is not very complicated, the “q” parameter can be just copied and replayed on SOLR manually. However, with the query above, SOLR won’t be able to parse the passed data.<br><br><br>I perform the following actions to make the query working and more readable:</p>
<ol>
<li><p>Retrieve only “q” parameter value (everything which goes from “q=” to “&amp;”).</p>
<p>The result will be the following:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">(x_type_s:(ContactDataRecord)+AND+_query_:(&quot;\&#123;\!type%3Djoin+from%3Dcontactid_s+to%3Did\&#125;\(x_type_s\:\(InteractionDataRecord\)+AND+_query_\:\(\&quot;\\\&#123;\\\!type%3Dparent+which%3Dx_type_s\\\:\\\(InteractionDataRecord\\\)\\\&#125;\\\(path_s\\\:\\\(Events\\\)+AND+\\\(\\\(@odata.type_s\\\:\\\(#Sitecore.EmailCampaign.Model.XConnect.Events.UnsubscribedFromEmailEvent\\\)+OR+\\\(@odata.type_s\\\:\\\(#Sitecore.EmailCampaign.Model.XConnect.Events.SpamComplaintEvent\\\)+OR+\\\(@odata.type_s\\\:\\\(#Sitecore.EmailCampaign.Model.XConnect.Events.EmailSentEvent\\\)+OR+\\\(@odata.type_s\\\:\\\(#Sitecore.EmailCampaign.Model.XConnect.Events.EmailOpenedEvent\\\)+OR+\\\(@odata.type_s\\\:\\\(#Sitecore.EmailCampaign.Model.XConnect.Events.EmailClickedEvent\\\)+OR+\\\(@odata.type_s\\\:\\\(#Sitecore.EmailCampaign.Model.XConnect.Events.DispatchFailedEvent\\\)+OR+\\\(@odata.type_s\\\:\\\(#Sitecore.EmailCampaign.Model.XConnect.Events.BounceEvent\\\)+OR+@odata.type_s\\\:\\\(#Sitecore.EmailCampaign.Model.XConnect.Events.EmailEvent\\\)\\\)\\\)\\\)\\\)\\\)\\\)\\\)+AND+\\\(definitionid_s\\\:\\\(2a65acc5985140dd851b23f7a6c53092\\\)+AND+messageid_s\\\:\\\(c7b8358d3fea4138b2b15d457bf4d2b6\\\)\\\)\\\)\\\)\&quot;\)\)&quot;))</span><br></pre></td></tr></table></figure>
</li>
<li><p>Decode the URL using some online decoder (for example: <a href="https://meyerweb.com/eric/tools/dencoder/" target="_blank" rel="noopener">https://meyerweb.com/eric/tools/dencoder/</a>)</p>
<p>The result will be the following:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">(x_type_s:(ContactDataRecord) AND _query_:(&quot;\&#123;\!type=join from=contactid_s to=id\&#125;\(x_type_s\:\(InteractionDataRecord\) AND _query_\:\(\&quot;\\\&#123;\\\!type=parent which=x_type_s\\\:\\\(InteractionDataRecord\\\)\\\&#125;\\\(path_s\\\:\\\(Events\\\) AND \\\(\\\(@odata.type_s\\\:\\\(#Sitecore.EmailCampaign.Model.XConnect.Events.UnsubscribedFromEmailEvent\\\) OR \\\(@odata.type_s\\\:\\\(#Sitecore.EmailCampaign.Model.XConnect.Events.SpamComplaintEvent\\\) OR \\\(@odata.type_s\\\:\\\(#Sitecore.EmailCampaign.Model.XConnect.Events.EmailSentEvent\\\) OR \\\(@odata.type_s\\\:\\\(#Sitecore.EmailCampaign.Model.XConnect.Events.EmailOpenedEvent\\\) OR \\\(@odata.type_s\\\:\\\(#Sitecore.EmailCampaign.Model.XConnect.Events.EmailClickedEvent\\\) OR \\\(@odata.type_s\\\:\\\(#Sitecore.EmailCampaign.Model.XConnect.Events.DispatchFailedEvent\\\) OR \\\(@odata.type_s\\\:\\\(#Sitecore.EmailCampaign.Model.XConnect.Events.BounceEvent\\\) OR @odata.type_s\\\:\\\(#Sitecore.EmailCampaign.Model.XConnect.Events.EmailEvent\\\)\\\)\\\)\\\)\\\)\\\)\\\)\\\) AND \\\(definitionid_s\\\:\\\(2a65acc5985140dd851b23f7a6c53092\\\) AND messageid_s\\\:\\\(c7b8358d3fea4138b2b15d457bf4d2b6\\\)\\\)\\\)\\\)\&quot;\)\)&quot;))</span><br></pre></td></tr></table></figure>
</li>
<li><p>Remove the backslashes:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">(x_type_s:(ContactDataRecord) AND _query_:(&quot;&#123;!type=join from=contactid_s to=id&#125;(x_type_s:(InteractionDataRecord) AND _query_:(&quot;&#123;!type=parent which=x_type_s:(InteractionDataRecord)&#125;(path_s:(Events) AND ((@odata.type_s:(#Sitecore.EmailCampaign.Model.XConnect.Events.UnsubscribedFromEmailEvent) OR (@odata.type_s:(#Sitecore.EmailCampaign.Model.XConnect.Events.SpamComplaintEvent) OR (@odata.type_s:(#Sitecore.EmailCampaign.Model.XConnect.Events.EmailSentEvent) OR (@odata.type_s:(#Sitecore.EmailCampaign.Model.XConnect.Events.EmailOpenedEvent) OR (@odata.type_s:(#Sitecore.EmailCampaign.Model.XConnect.Events.EmailClickedEvent) OR (@odata.type_s:(#Sitecore.EmailCampaign.Model.XConnect.Events.DispatchFailedEvent) OR (@odata.type_s:(#Sitecore.EmailCampaign.Model.XConnect.Events.BounceEvent) OR @odata.type_s:(#Sitecore.EmailCampaign.Model.XConnect.Events.EmailEvent)))))))) AND (definitionid_s:(2a65acc5985140dd851b23f7a6c53092) AND messageid_s:(c7b8358d3fea4138b2b15d457bf4d2b6))))&quot;))&quot;))</span><br></pre></td></tr></table></figure>
<p>Now the query is readable and can be analyzed. If you want to replay it as well, extra modifications are required.</p>
</li>
<li><p>Hashes can’t be parsed, so you need to replace them with the corresponding symbol code: %23</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">(x_type_s:(ContactDataRecord) AND _query_:(&quot;&#123;!type=join from=contactid_s to=id&#125;(x_type_s:(InteractionDataRecord) AND _query_:(&quot;&#123;!type=parent which=x_type_s:(InteractionDataRecord)&#125;(path_s:(Events) AND ((@odata.type_s:(%23Sitecore.EmailCampaign.Model.XConnect.Events.UnsubscribedFromEmailEvent) OR (@odata.type_s:(%23Sitecore.EmailCampaign.Model.XConnect.Events.SpamComplaintEvent) OR (@odata.type_s:(%23Sitecore.EmailCampaign.Model.XConnect.Events.EmailSentEvent) OR (@odata.type_s:(%23Sitecore.EmailCampaign.Model.XConnect.Events.EmailOpenedEvent) OR (@odata.type_s:(%23Sitecore.EmailCampaign.Model.XConnect.Events.EmailClickedEvent) OR (@odata.type_s:(%23Sitecore.EmailCampaign.Model.XConnect.Events.DispatchFailedEvent) OR (@odata.type_s:(%23Sitecore.EmailCampaign.Model.XConnect.Events.BounceEvent) OR @odata.type_s:(%23Sitecore.EmailCampaign.Model.XConnect.Events.EmailEvent)))))))) AND (definitionid_s:(2a65acc5985140dd851b23f7a6c53092) AND messageid_s:(c7b8358d3fea4138b2b15d457bf4d2b6))))&quot;))&quot;))</span><br></pre></td></tr></table></figure>
</li>
<li><p>The query which I used as example has _query_ element, which must have value in quotes. The nested query also has its own inner _query_ element, which must be in quotes as well. As a result, the inner quotes must be properly encoded, otherwise the query will be messed up. I used %5C%22 to replace the inner quotes, which corresponds to \“ symbols:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">(x_type_s:(ContactDataRecord) AND _query_:(&quot;&#123;!type=join from=contactid_s to=id&#125;(x_type_s:(InteractionDataRecord) AND _query_:( %5C%22&#123;!type=parent which=x_type_s:(InteractionDataRecord)&#125;(path_s:(Events) AND ((@odata.type_s:(%23Sitecore.EmailCampaign.Model.XConnect.Events.UnsubscribedFromEmailEvent) OR (@odata.type_s:(%23Sitecore.EmailCampaign.Model.XConnect.Events.SpamComplaintEvent) OR (@odata.type_s:(%23Sitecore.EmailCampaign.Model.XConnect.Events.EmailSentEvent) OR (@odata.type_s:(%23Sitecore.EmailCampaign.Model.XConnect.Events.EmailOpenedEvent) OR (@odata.type_s:(%23Sitecore.EmailCampaign.Model.XConnect.Events.EmailClickedEvent) OR (@odata.type_s:(%23Sitecore.EmailCampaign.Model.XConnect.Events.DispatchFailedEvent) OR (@odata.type_s:(%23Sitecore.EmailCampaign.Model.XConnect.Events.BounceEvent) OR @odata.type_s:(%23Sitecore.EmailCampaign.Model.XConnect.Events.EmailEvent)))))))) AND (definitionid_s:(2a65acc5985140dd851b23f7a6c53092) AND messageid_s:(c7b8358d3fea4138b2b15d457bf4d2b6)))) %5C%22))&quot;))</span><br></pre></td></tr></table></figure>
</li>
<li><p>The query above can be executed against SOLR. It can be done by requesting the following URL in browser:</p>
<p><a href="https://localhost:8984/solr/sc901_xdb/select?indent=on&amp;q=TheQueryGoesHere" target="_blank" rel="noopener">https://localhost:8984/solr/sc901_xdb/select?indent=on&amp;q=TheQueryGoesHere</a></p>
<p>Where <em>sc901_xdb</em> is the name of the core, and the found query is passed using q parameter.</p>
</li>
</ol>

          
        
      </div>
      <footer>
        
          <div class="alignright">
            <a href="/2019/09/07/SOLRQueryReplaying/#more" class="more-link">Continue Reading<i class="fa fa-long-arrow-right fa-1"></i></a>
          </div>
        
        <div class="clearfix"></div>
      </footer>
    </div>
</article>




  <article class="post">
  
  
    <div class="post-content-index">
  
      
        <header>
          <!-- <div class="icon"></div> -->
            
    
      <h1 class="metro-title transition"><a href="/2019/08/17/HowEAReduceFunctionalityWorks/">How Experience Analytics Reduce functionality works</a></h1>
    
  
          <ul>
            <li>
              <span class="heading-span">Posted on: </span>
              <time datetime="2019-08-17T20:24:48.000Z">2019-08-17</time>
            </li>
            
              <li>
                <span class="heading-span">By: </span>

                
                  <a href="/">Sergey Plashenko</a>
                

              </li>
            
            <li>
              <!--span class="heading-span">With: </span-->
              
                <a href="/2019/08/17/HowEAReduceFunctionalityWorks/#disqus_thread">Comments</a>

              
          </ul>
        </header>
      
      <div class="entry">
        
          
            <p>During the five years working with Experience Analytics, I have never had a chance to deep dive into segment reducing functionality.<br>Several days ago, the time has finally came and I had to find out how it works. I decided to describe it in detail, possibly somebody will find this interesting.<br><br>I used 8.2.7 version for demonstration, though the functionality should be pretty much the same in previous versions and revisions of 8.x.</p>
<h2 id="Demo-Data"><a href="#Demo-Data" class="headerlink" title="Demo Data"></a>Demo Data</h2><p>I created a small example to demonstrate the reduce manager work.<br>There is <em>Campaign Group 1</em> campaign group, which has 3 campaigns with the following names:<br><em>Campaign1</em><br><em>Campaign2</em><br><em>Campaign3</em></p>
<p>The report for the <em>Campaign Group 1</em> group looks as follows:</p>
<p><img src="/images/HowEAReduceFunctionalityWorks/SeparateNumbers.png" alt></p>
<p>Experience Analytics uses 5 tables to retrieve the data in Sitecore 8.2: <em>SegmentRecords</em>, <em>Fact_SegmentMetrics</em>, <em>SegmentRecordsReduced</em>, <em>Fact_SegmentMetricsReduced</em>, <em>DimensionKeys</em>.<br>Here is approximate query which can help to understand the exact way of how records are stored (we consider that the reducer has not been executed yet):</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="built_in">Date</span>, Visits, <span class="keyword">Value</span>, DimensionKey</span><br><span class="line"><span class="keyword">FROM</span> [SegmentRecords] <span class="keyword">JOIN</span> [Fact_SegmentMetrics] </span><br><span class="line"><span class="keyword">ON</span> [SegmentRecords].SegmentRecordId = [Fact_SegmentMetrics].SegmentRecordId</span><br><span class="line"><span class="keyword">JOIN</span> [DimensionKeys] <span class="keyword">ON</span> [SegmentRecords].DimensionKeyId = [DimensionKeys].DimensionKeyId</span><br><span class="line"><span class="keyword">WHERE</span> SegmentId = <span class="string">'7A9A483F-195D-4F96-AD88-473CD6854C4F'</span></span><br></pre></td></tr></table></figure>
<p>The <em>SegmentRecordsReduced</em>, <em>Fact_SegmentMetricsReduced</em> tables are not used for now, since they are populated when reducing is performed.<br>The query gives the following results:</p>
<p><img src="/images/HowEAReduceFunctionalityWorks/NonReducedResults.png" alt></p>
<p>The first ID in the DimensionKey is the campaign group id. The second id is the id of the campaign. Thus, we have the same results as in the report:<br><em>156e78f3-f4ea-43d1-8607-07c38ccc53a9 - 13 times<br>4ba98edb-b73c-4951-a5bc-6f4210651a3a - 2 times<br>f4701287-86e2-4534-8358-5701cdb5c7ee - 1 time.</em></p>
<h2 id="Reduce-functionality"><a href="#Reduce-functionality" class="headerlink" title="Reduce functionality"></a>Reduce functionality</h2><p>Reducer compresses the data which is considered insignificant by the system. It allows having less records in the database, which makes the query execution fast even for the big databases.</p>
<p>All reducing related configuration can be found in the following file:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">App_Config\Include\ExperienceAnalytics\Sitecore.ExperienceAnalytics.Reduce.config</span><br></pre></td></tr></table></figure>
<p>There is a <em>reduceLoader</em> hook, which makes ReduceAgent to be executed every 30 seconds.<br><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">agent</span> <span class="attr">type</span>=<span class="string">"Sitecore.ExperienceAnalytics.Reduce.ReduceAgent, Sitecore.ExperienceAnalytics.Reduce"</span> &gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">param</span> <span class="attr">desc</span>=<span class="string">"connectionStringName"</span>&gt;</span>reporting<span class="tag">&lt;/<span class="name">param</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">param</span> <span class="attr">desc</span>=<span class="string">"triggerHour"</span>&gt;</span>1<span class="tag">&lt;/<span class="name">param</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">param</span> <span class="attr">desc</span>=<span class="string">"logger"</span> <span class="attr">ref</span>=<span class="string">"experienceAnalytics/reduce/logger"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">param</span> <span class="attr">ref</span>=<span class="string">"experienceAnalytics/reduce/manager"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">agent</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>Interesting parameter here is the <em>triggerHour</em>, which defines that the ReduceAgent can do it work only at this particular hour, which is 1AM by default. If the agent wakes up at other hour, it will just do nothing.<br>Apart from that, the reduce agent can do its work only once in 24 hours. The value of the last execution is stored in the properties table of the reporting database:<br><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> [Properties]</span><br><span class="line"><span class="keyword">WHERE</span> [<span class="keyword">Key</span>] = <span class="string">'EA_reduce_lastrun'</span></span><br></pre></td></tr></table></figure></p>
<p>The agent delegates the execution to ReduceManager:</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">manager</span> <span class="attr">type</span>=<span class="string">"Sitecore.ExperienceAnalytics.Reduce.ReduceManager, Sitecore.ExperienceAnalytics.Reduce"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">param</span> <span class="attr">desc</span>=<span class="string">"connectionStringName"</span>&gt;</span>reporting<span class="tag">&lt;/<span class="name">param</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">param</span> <span class="attr">desc</span>=<span class="string">"retentionDays"</span>&gt;</span>7<span class="tag">&lt;/<span class="name">param</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">param</span> <span class="attr">desc</span>=<span class="string">"logger"</span> <span class="attr">ref</span>=<span class="string">"experienceAnalytics/reduce/logger"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">manager</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>The <em>retentionDays</em> parameter defines how many days the aggregated data remains untouched by reduce manager. </p>
<p>ReduceManager has specific time for which it is allowed to run. By default, it is 1 hour and can be configured using the following setting:<br><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">setting</span> <span class="attr">name</span>=<span class="string">"ExperienceAnalytics.Reduce.Timeout"</span> <span class="attr">value</span>=<span class="string">"01:00:00"</span> /&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>If the execution time is exceeded, the operation is aborted.<br><br></p>
<p>Reduce manager is executed for each site from the <em>SiteNames</em> table of the reporting database and for each segment. There are several checkups in the code which may prevent segment reducing. Mostly, this can happen if re-aggregation is in process or if there is no data for the particular segment which is older than 7 days. Corresponding messages are written to a log file with Info level.</p>
<p>The main  reducing logic is performed by the <em>ReduceSegmentMetrics</em> stored procedure. First of all, the data for further reducing is retrieved. It is done using the query like follows:<br><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> ROW_NUMBER() <span class="keyword">OVER</span>(<span class="keyword">ORDER</span> <span class="keyword">BY</span> sm.Visits <span class="keyword">DESC</span>, <span class="keyword">ABS</span>(sm.Value) <span class="keyword">DESC</span>) <span class="keyword">AS</span> <span class="string">'PredicateOrder'</span>,</span><br><span class="line">sr.[SegmentId],</span><br><span class="line">sr.[<span class="built_in">Date</span>],</span><br><span class="line">sr.[SiteNameId],</span><br><span class="line">sr.[DimensionKeyId],</span><br><span class="line">sm.[SegmentRecordId],</span><br><span class="line">sm.[ContactTransitionType],</span><br><span class="line">sm.[Visits],</span><br><span class="line">sm.[<span class="keyword">Value</span>],</span><br><span class="line">sm.[Bounces],</span><br><span class="line">sm.[Conversions],</span><br><span class="line">sm.[TimeOnSite],</span><br><span class="line">sm.[Pageviews],</span><br><span class="line">sm.[<span class="keyword">Count</span>]</span><br><span class="line"><span class="keyword">FROM</span> SegmentRecords sr</span><br><span class="line"><span class="keyword">INNER</span> <span class="keyword">JOIN</span> Fact_SegmentMetrics sm <span class="keyword">ON</span> sr.SegmentRecordId = sm.SegmentRecordId</span><br><span class="line"><span class="keyword">INNER</span> <span class="keyword">JOIN</span> DimensionKeys dk <span class="keyword">ON</span> dk.DimensionKeyId = sr.DimensionKeyId</span><br><span class="line"><span class="keyword">WHERE</span> sr.SegmentId = <span class="string">'7A9A483F-195D-4F96-AD88-473CD6854C4F'</span> <span class="keyword">AND</span> sr.[<span class="built_in">Date</span>] &gt;= <span class="string">'2019-08-16 00:00:00'</span> <span class="keyword">AND</span> </span><br><span class="line">sr.[<span class="built_in">Date</span>] &lt; <span class="string">'2019-08-17 00:00:00'</span></span><br></pre></td></tr></table></figure></p>
<p>The resulting table in our case will be:<br><img src="/images/HowEAReduceFunctionalityWorks/ReducerSelectResult.png" alt><br>The records in the table are ordered by number of visits and engagement value and each row has <em>PredicateOrder</em> number assigned. If the number of records is too big, only first <em>n</em> records remain and the other ones are reduced. The <em>PredicateOrder</em> helps to understand which records to leave.<br>By default, only first 1000 records are significant ones and the rest is reduced. It can be controlled using the following setting:<br><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">setting</span> <span class="attr">name</span>=<span class="string">"ExperienceAnalytics.Reduce.DefaultKeepCountThreshold"</span> <span class="attr">value</span>=<span class="string">"1000"</span> /&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>In our case, this setting does not affect the behavior since there are only 4 records for the segment.<br>The resulting relation is filtered further using Visits and Value metrics. By default only records with Visits &gt; 10 are considered<br>significant. As for value, by default ABS(Value) must be &gt; -1 (which is always true) to be significant.<br>The corresponding default values can be changed in the configuration:<br><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">setting</span> <span class="attr">name</span>=<span class="string">"ExperienceAnalytics.Reduce.DefaultValueThreshold"</span> <span class="attr">value</span>=<span class="string">"-1"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">setting</span> <span class="attr">name</span>=<span class="string">"ExperienceAnalytics.Reduce.DefaultVisitThreshold"</span> <span class="attr">value</span>=<span class="string">"10"</span> /&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>The change will affect all segments.<br><br></p>
<p>Also each particular segment can be configured independently. To do that, the dimension which corresponds to a segment must be found first. It can be done as follows:</p>
<ol>
<li>Find the needed segment in the master database using Content Editor.</li>
<li>The segment parent item is the needed dimension.</li>
<li>Use the dimension id to find it in the <em>Sitecore.ExperienceAnalytics.Reduce.config</em> file. Using the <em>visitThreshold</em> and <em>valueThreshold</em> attributes it is possible to define the required thresholds. </li>
</ol>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dimension</span> <span class="attr">id</span>=<span class="string">"&#123;3E01BA28-2B4D-408A-A4BA-6C51ED9FFB9C&#125;"</span> <span class="attr">type</span>=<span class="string">"Sitecore.ExperienceAnalytics.Aggregation.Dimensions.ByCampaign, Sitecore.ExperienceAnalytics.Aggregation"</span> <span class="attr">visitThreshold</span>=<span class="string">"1"</span> <span class="attr">valueThreshold</span>=<span class="string">"-1"</span>/&gt;</span></span><br></pre></td></tr></table></figure>
<p>In the configuration above, the records which have more that 1 visit and any value are considered as significant.<br><br><br>In my case (with default configuration) only the first record is significant. The rest of the records will be reduced. Value, Visits, Bounces, etc. will be summed up and only one reduced record with [Other] DimensionKey will be stored in <em>Fact_SegmentMetricsReduced</em> and <em>SegmentRecordsReduced</em> tables (note that initially <em>Fact_SegmentMetrics</em> and <em>SegmentRecords</em> tables). The reduced data will be purged from the <em>Fact_SegmentMetrics</em> and <em>SegmentRecords</em> tables after stored procedure work is finished.<br>Running the query against <em>Fact_SegmentMetrics</em> and <em>SegmentRecords</em> tables will return no results now. If the same query is executed against <em>Fact_SegmentMetricsReduced</em> and <em>SegmentRecordsReduced</em> tables, the result will be the following:</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="built_in">Date</span>, Visits, <span class="keyword">Value</span>, DimensionKey</span><br><span class="line"><span class="keyword">FROM</span> [SegmentRecordsReduced] <span class="keyword">JOIN</span> [Fact_SegmentMetricsReduced] </span><br><span class="line"><span class="keyword">ON</span> [SegmentRecordsReduced].SegmentRecordId = [Fact_SegmentMetricsReduced].SegmentRecordId</span><br><span class="line"><span class="keyword">JOIN</span> [DimensionKeys] <span class="keyword">ON</span> [SegmentRecordsReduced].DimensionKeyId = [DimensionKeys].DimensionKeyId</span><br><span class="line"><span class="keyword">WHERE</span> SegmentId = <span class="string">'7A9A483F-195D-4F96-AD88-473CD6854C4F'</span></span><br></pre></td></tr></table></figure>
<p><br></p>
<p><img src="/images/HowEAReduceFunctionalityWorks/ReducedResults.png" alt></p>
<p>As it can be seen, non-significant data is stored with <em>[Other]</em> dimension key, thus can’t be used for displaying particular campaigns in the reports. The report shows the following data after the reducer finished its work:</p>
<p><img src="/images/HowEAReduceFunctionalityWorks/ReportAfterReducing.png" alt></p>
<h2 id="Summary"><a href="#Summary" class="headerlink" title="Summary"></a>Summary</h2><p>Considering the above, we now know that Experience Analytics reports may show less data after some time. Using the configuration settings this behavior can be adjusted to meet the requirements:</p>
<ol>
<li><em>retentionDays</em> value can be increased. In this case, the data will remain unchanged for longer time.</li>
<li>Reduce functionality can be disabled completely by disabling the <em>Sitecore.ExperienceAnalytics.Reduce.config</em> file. However, please note that this approach may lead to reporting database grows and as a result the queries will be executed slowly if the amount of data is too big.</li>
<li>Specific segments can be reconfigured using the <em>visitThreshold</em> and <em>valueThreshold</em> attributes as it was described above.</li>
<li>It is also possible to comment out specific dimension under the <em>experienceAnalytics/reduce/dimensions</em> node, however it is not the way which EA treats as valid one. If the dimension is present under the <em>experienceAnalytics/aggregation/dimensions</em> node it should be present under the <em>experienceAnalytics/reduce/dimensions</em> node as well. Otherwise, the following error will appear in a log:</li>
</ol>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">ERROR [Experience Analytics]: Error trying to reduce segment: ea364d4d-b85c-4c07-88d1-51edcaa1a160, date: 8/16/2019, site: website</span><br></pre></td></tr></table></figure>
<p>Though, the error is not critical and does not seem to break something.</p>

          
        
      </div>
      <footer>
        
          <div class="alignright">
            <a href="/2019/08/17/HowEAReduceFunctionalityWorks/#more" class="more-link">Continue Reading<i class="fa fa-long-arrow-right fa-1"></i></a>
          </div>
        
        <div class="clearfix"></div>
      </footer>
    </div>
</article>




  <article class="post">
  
  
    <div class="post-content-index">
  
      
        <header>
          <!-- <div class="icon"></div> -->
            
    
      <h1 class="metro-title transition"><a href="/2019/08/04/MissingDefinitionItems/">How to address &#34;Definition not found&#34; issue during aggregation</a></h1>
    
  
          <ul>
            <li>
              <span class="heading-span">Posted on: </span>
              <time datetime="2019-08-04T14:02:33.000Z">2019-08-04</time>
            </li>
            
              <li>
                <span class="heading-span">By: </span>

                
                  <a href="/">Sergey Plashenko</a>
                

              </li>
            
            <li>
              <!--span class="heading-span">With: </span-->
              
                <a href="/2019/08/04/MissingDefinitionItems/#disqus_thread">Comments</a>

              
          </ul>
        </header>
      
      <div class="entry">
        
          
            <h3 id="Issue-description"><a href="#Issue-description" class="headerlink" title="Issue description"></a>Issue description</h3><p>The following exception is quite popular and can be found in the log files when the processing speed is low:<br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">165164 14:04:56 WARN  Failed to process interaction with Id 2e58c56c-d6c7-452b-a1d1-2b068c15372c and ContactId &#123;F9BE0608-E18C-4A35-B2C2-EA3C5226C107&#125;. Processing will be retried later.</span><br><span class="line">Exception: System.InvalidOperationException</span><br><span class="line">Message: Definition not found: itemId: &apos;&#123;38AAA41B-E509-4083-B876-799B809F13BA&#125;&apos; culture: &apos;Invariant Language (Invariant Country)&apos; type: &apos;Sitecore.Marketing.Definitions.Goals.IGoalDefinition&apos;</span><br><span class="line">Source: Sitecore.ExperienceAnalytics.Aggregation</span><br><span class="line">   at Sitecore.ExperienceAnalytics.Aggregation.Pipeline.SegmentProcessor.ProcessSegments(AggregationPipelineArgs args, IEnumerable`1 segments)</span><br><span class="line">   at Sitecore.ExperienceAnalytics.Aggregation.Pipeline.SegmentProcessor.OnProcess(AggregationPipelineArgs args)</span><br><span class="line">   at Sitecore.Analytics.Aggregation.Pipeline.AggregationProcessor.Process(AggregationPipelineArgs args)</span><br><span class="line">   at (Object , Object )</span><br><span class="line">   at Sitecore.Pipelines.CorePipeline.Run(PipelineArgs args)</span><br><span class="line">   at Sitecore.Pipelines.DefaultCorePipelineManager.Run(String pipelineName, PipelineArgs args, String pipelineDomain, Boolean failIfNotExists)</span><br><span class="line">   at Sitecore.Pipelines.DefaultCorePipelineManager.Run(String pipelineName, PipelineArgs args, String pipelineDomain)</span><br><span class="line">   at Sitecore.Analytics.Aggregation.Pipeline.AggregationPipeline.Run(AggregationPipelineArgs args)</span><br><span class="line">   at Sitecore.Analytics.Aggregation.InteractionBatchAggregator.Aggregate(IVisitAggregationContext interaction, InteractionAggregationType interactionAggregationType, RebuildTargets targets)</span><br><span class="line">   at Sitecore.Analytics.Aggregation.InteractionBatchAggregator.Aggregate(ItemBatch`1 batch, InteractionAggregationType interactionAggregationType, RebuildTargets targets)</span><br><span class="line"></span><br><span class="line">Nested Exception</span><br><span class="line"></span><br><span class="line">Exception: System.InvalidOperationException</span><br><span class="line">Message: Definition not found: itemId: &apos;&#123;38AAA41B-E509-4083-B876-799B809F13BA&#125;&apos; culture: &apos;Invariant Language (Invariant Country)&apos; type: &apos;Sitecore.Marketing.Definitions.Goals.IGoalDefinition&apos;</span><br><span class="line">Source: Sitecore.ExperienceAnalytics.Core</span><br><span class="line">...</span><br></pre></td></tr></table></figure></p>
<p><br></p>
<p>As it is seen from the stacktrace and the message, the exception is thrown during aggregation when converted goal can’t be found.<br>The processing pool will contain the records with attempts &gt; 0 in this case:<br><img src="/images/pool.png" alt="pool"></p>
<p><br><br>As a result, each record with missing goal will be tried to be processed 10 times. Even with small amount of data, this will slow down the aggregation process significantly.<br><br>There are two main sources of the marketing definition items:</p>
<ol>
<li>Master database is the main marketing definitions storage (source of trust). Definitions are retrieved from the master database when standolone instance is used.</li>
<li>Reporting database is the definitions storage, which is used for aggregation if dedicated processing server is in place.</li>
</ol>
<p><br></p>
<p>To address the issue, the following actions can be performed:</p>
<ol>
<li>Try to find the item which corresponds to the missing item ID in the master database. If the item is present in the master database, the issue is most likely happens due to the fact that the definition is missing in the reporting database. <a href="https://doc.sitecore.com/users/91/sitecore-experience-platform/en/deploy-marketing-definitions-and-taxonomies.html" target="_blank" rel="noopener">Redeploying the definitions</a> using the Control Panel must solve the issue.</li>
<li>In case if the item is missing, everything becomes a bit more difficult. The situation is the following: there is data in the collection database, which was collected for a goal which was removed. </li>
</ol>
<p><br></p>
<h3 id="What-to-do-if-the-definition-is-missing-in-the-master-database"><a href="#What-to-do-if-the-definition-is-missing-in-the-master-database" class="headerlink" title="What to do if the definition is missing in the master database?"></a>What to do if the definition is missing in the master database?</h3><p>The collection database stores the id of the goal item and during the aggregation, it should be retrieved from the definitions storage to get addition info (like assets).<br>Thus, to overcome the exceptions, it is possible to recreate the goals with the same ids as stored in the collection database. Here is the approach which I used:</p>
<ol>
<li>Backup the solution.</li>
<li>For each problematic id from the log files like 38AAA41B-E509-4083-B876-799B809F13BA here:<br><em>Definition not found: itemId: ‘<strong>{38AAA41B-E509-4083-B876-799B809F13BA}’</strong> culture: ‘Invariant Language (Invariant Country)’ type: ‘Sitecore.Marketing.Definitions.Goals.IGoalDefinition’</em><br><br>Ensure that the item does not exist and create a new goal item under <em>/sitecore/system/Marketing Control Panel/Goals</em> item. Do not deploy it. You can name it the way you want.  </li>
<li>Copy the created goal id. </li>
<li>Now, we need to replace this id in the master database with the one from the log files. It can be done using the following SQL code executed against Master database:<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">declare</span> @itemId uniqueidentifier = <span class="string">'&#123;F451B31C-71D2-4433-B449-C9886E9A09EC&#125;'</span> <span class="comment">-- Your created goal id goes here.</span></span><br><span class="line"><span class="keyword">declare</span> @oldItemId uniqueidentifier = <span class="string">'&#123;38AAA41B-E509-4083-B876-799B809F13BA&#125;'</span> <span class="comment">-- id from the log files goes here.</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">UPDATE</span> [dbo].SharedFields</span><br><span class="line"><span class="keyword">SET</span> ItemId = @oldItemId</span><br><span class="line"><span class="keyword">WHERE</span> ItemId = @itemId</span><br><span class="line"></span><br><span class="line"><span class="keyword">UPDATE</span> [dbo].VersionedFields</span><br><span class="line"><span class="keyword">SET</span> ItemId = @oldItemId</span><br><span class="line"><span class="keyword">WHERE</span> ItemId = @itemId</span><br><span class="line"></span><br><span class="line"><span class="keyword">UPDATE</span> [dbo].Items</span><br><span class="line"><span class="keyword">SET</span> <span class="keyword">ID</span> = @oldItemId</span><br><span class="line"><span class="keyword">WHERE</span> <span class="keyword">ID</span> = @itemId</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p><br></p>
<p>   Before running the update scripts, it is better to ensure that the item does not exist in DB:<br>   <figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> *</span><br><span class="line"><span class="keyword">FROM</span> [dbo].Items <span class="keyword">where</span> <span class="keyword">ID</span> = @oldItemId</span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> *</span><br><span class="line"><span class="keyword">FROM</span> [dbo].SharedFields <span class="keyword">where</span> ItemId = @oldItemId</span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> *</span><br><span class="line"><span class="keyword">FROM</span> [dbo].VersionedFields <span class="keyword">where</span> ItemId = @oldItemId*</span><br></pre></td></tr></table></figure></p>
<p><br></p>
<p>   Since Sitecore has number of caching layers, to have the relevant data in the Content Editor, I recommend stopping the Sitecore instance when performing the SQL operation. </p>
<ol start="5">
<li>Start Sitecore instance and check that the created goals have correct IDs now (if you do not stop the process during running the scripts, you may get old IDs since they will be taken from cache).</li>
<li>Deploy the goals.</li>
<li>Check if the exceptions disappeared from the log files for the recreated goal ids.</li>
</ol>
<p><br></p>
<p>The approach was checked for 8.2.7, should work for 9.x in the same way. The same behavior may be experienced for other marketing definitions (like campaigns). The approach is the same, the only difference is the definition item which needs to be created on the 2nd step.</p>
<p><br></p>
<p>P.S. When completing this article, I though about using ItemManager to create the item with corresponding ID. Did not check it, though I believe it should work as well.</p>
<p><br></p>
<p>P.P.S Do not remove the marketing definitions once created!</p>

          
        
      </div>
      <footer>
        
          <div class="alignright">
            <a href="/2019/08/04/MissingDefinitionItems/#more" class="more-link">Continue Reading<i class="fa fa-long-arrow-right fa-1"></i></a>
          </div>
        
        <div class="clearfix"></div>
      </footer>
    </div>
</article>




  <article class="post">
  
  
    <div class="post-content-index">
  
      
        <header>
          <!-- <div class="icon"></div> -->
            
    
      <h1 class="metro-title transition"><a href="/2019/07/22/MarketingAutomationLogging/">How to inject logging to Marketing Automation condition</a></h1>
    
  
          <ul>
            <li>
              <span class="heading-span">Posted on: </span>
              <time datetime="2019-07-22T20:31:00.000Z">2019-07-22</time>
            </li>
            
              <li>
                <span class="heading-span">By: </span>

                
                  <a href="/">Sergey Plashenko</a>
                

              </li>
            
            <li>
              <!--span class="heading-span">With: </span-->
              
                <a href="/2019/07/22/MarketingAutomationLogging/#disqus_thread">Comments</a>

              
          </ul>
        </header>
      
      <div class="entry">
        
          
            <p>The best way to understand why something does not work is debugging it. Unfortunately, it is not always possible to attach VS or windbg to a running process. In such cases, I usually extend the code with logging and check the output. </p>
<p><br></p>
<p>Some time ago I had issues with non-working Marketing Automation condition. This was custom condition and I had code for it. After some time monitoring the MA pool without success, I decided to inject logging into the condition Evaluate method to troubleshoot it. The conditions are processed by maengine service, thus usual Sitecore Log.Info() call won’t work here since there is no Sitecore.Kernel assembly reference.  Using DI and passing the ILogger via condition constructor won’t work either since the conditions are created using Activator and require parameter-less constructor.  </p>
<p><br></p>
<p>MA has quite elegant extension points, which allow us to get the ILogger from condition. The Evaluate method gets IRuleExecutionContext as a parameter, the interface has only one method Fact which is used for getting contact, interaction and other required information. We will use it to get the needed ILogger implementation. I will use test FirstNameCondition further to demonstrate the behavior.  </p>
<p><br></p>
<figure class="highlight cs"><table><tr><td class="code"><pre><span class="line"><span class="keyword">using</span> Serilog;</span><br><span class="line"><span class="keyword">using</span> Sitecore.Framework.Rules;</span><br><span class="line"><span class="keyword">using</span> Sitecore.XConnect;</span><br><span class="line"><span class="keyword">using</span> Sitecore.XConnect.Collection.Model;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">TestCondition</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">FirstNameCondition</span> : <span class="title">ICondition</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">bool</span> <span class="title">Evaluate</span>(<span class="params">IRuleExecutionContext context</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">var</span> logger = context.Fact&lt;ILogger&gt;();</span><br><span class="line">            logger.Information(<span class="string">"Condition was executed"</span>);</span><br><span class="line">            <span class="keyword">var</span> contact = context.Fact&lt;Contact&gt;();</span><br><span class="line">            <span class="keyword">return</span> contact.Personal()?.FirstName == <span class="string">"Sergey"</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><br></p>
<p>By default, the ILogger object is not present in context and we need to register it. It can be done by overriding the PopulateScopedFacts method of the ConditionEvaluationService.  </p>
<figure class="highlight cs"><table><tr><td class="code"><pre><span class="line">public class ConditionEvaluationService : Sitecore.Xdb.MarketingAutomation.Rules.ConditionEvaluationService</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">readonly</span> ILogger&lt;Sitecore.Xdb.MarketingAutomation.Rules.ConditionEvaluationService&gt; _logger;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ConditionEvaluationService</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">        ILogger&lt;Sitecore.Xdb.MarketingAutomation.Rules.ConditionEvaluationService&gt; logger,</span></span></span><br><span class="line"><span class="function"><span class="params">        IConditionSerializer serializer, IServiceProvider serviceProvider</span>) : <span class="title">base</span>(<span class="params">logger, serializer,</span></span></span><br><span class="line"><span class="function"><span class="params">        serviceProvider</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        _logger = logger;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ConditionEvaluationService</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">        ILogger&lt;Sitecore.Xdb.MarketingAutomation.Rules.ConditionEvaluationService&gt; logger,</span></span></span><br><span class="line"><span class="function"><span class="params">        IConditionSerializer serializer, IConditionCache cache, IServiceProvider serviceProvider</span>) : <span class="title">base</span>(<span class="params">logger,</span></span></span><br><span class="line"><span class="function"><span class="params">        serializer, cache, serviceProvider</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        _logger = logger;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">PopulateScopedFacts</span>(<span class="params">FactSpecificier facts, IContactProcessingContext processingContext,</span></span></span><br><span class="line"><span class="function"><span class="params">        IConditionServices conditionServices, ISegmentationServiceContext segmentationServiceContext</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">base</span>.PopulateScopedFacts(facts, processingContext, conditionServices, segmentationServiceContext);</span><br><span class="line">        facts.Fact&lt;ILogger&gt;(_logger);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><br></p>
<p>The corresponding service must be replaced by a custom one in the following file:  </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">App_data\jobs\continuous\AutomationEngine\App_Data\Config\sitecore\MarketingAutomation\sc.MarketingAutomation.ConditionEvaluationService.xml</span><br></pre></td></tr></table></figure>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">MarketingAutomation.Rules.ConditionEvaluationService</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">Type</span>&gt;</span>CustomNamespace.ConditionEvaluationService, CustomAssembly<span class="tag">&lt;/<span class="name">Type</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">As</span>&gt;</span>Sitecore.Xdb.MarketingAutomation.Core.Rules.IConditionEvaluationService, Sitecore.Xdb.MarketingAutomation.Core<span class="tag">&lt;/<span class="name">As</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">LifeTime</span>&gt;</span>Singleton<span class="tag">&lt;/<span class="name">LifeTime</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">MarketingAutomation.Rules.ConditionEvaluationService</span>&gt;</span></span><br></pre></td></tr></table></figure>

          
        
      </div>
      <footer>
        
          <div class="alignright">
            <a href="/2019/07/22/MarketingAutomationLogging/#more" class="more-link">Continue Reading<i class="fa fa-long-arrow-right fa-1"></i></a>
          </div>
        
        <div class="clearfix"></div>
      </footer>
    </div>
</article>





<nav id="pagination">
  
  
  <div class="clearfix"></div>
</nav></div></div>
    <aside id="sidebar" class="alignright"><div class="padding">
	
	  <div class="search">
  <form action="//google.com/search" method="get" accept-charset="utf-8">
    <input type="search" name="q" results="0" placeholder="Search">
    <input type="hidden" name="q" value="site:spl-tricks.github.io">
  </form>
</div>
	
	  
<div class="widget recent-post">
  <h3 class="title">Recent Posts</h3>
  <ul class="entry">
    
      <li>
        <a href="/2019/09/07/SOLRQueryReplaying/">How to get the SOLR query generated by xConnect search and replay it</a>
      </li>
    
      <li>
        <a href="/2019/08/17/HowEAReduceFunctionalityWorks/">How Experience Analytics Reduce functionality works</a>
      </li>
    
      <li>
        <a href="/2019/08/04/MissingDefinitionItems/">How to address &#34;Definition not found&#34; issue during aggregation</a>
      </li>
    
      <li>
        <a href="/2019/07/22/MarketingAutomationLogging/">How to inject logging to Marketing Automation condition</a>
      </li>
    
  </ul>
</div>

	
	  
	
	  
<div class="widget tag">
  <h3 class="title">Tags</h3>
  
    <a href="/tags/Experience-Analytics/">Experience Analytics<small>1</small></a>
  
    <a href="/tags/Marketing-Automation/">Marketing Automation<small>1</small></a>
  
    <a href="/tags/SOLR/">SOLR<small>1</small></a>
  
    <a href="/tags/Sitecore/">Sitecore<small>3</small></a>
  
    <a href="/tags/xConnect/">xConnect<small>1</small></a>
  
    <a href="/tags/xConnect-Search/">xConnect Search<small>1</small></a>
  
    <a href="/tags/xDB/">xDB<small>3</small></a>
  
</div>

	
</div></aside>
    <div class="clearfix"></div>
  </div>
  <footer id="footer" class="inner"><div class="padding">
	<div class="alignleft">
	  
	  &copy; 2019 Sergey Plashenko
	  
	  <p>Powerd by <a href="http://hexo.io/" target="_blank">hexo</a>
	  and theme is modified <a href="https://github.com/halfer53/metro-light" target="_blank">metro-light</a></p>
	</div>

	<div class="alignright">
		
			<a href="https://github.com/sc-spl" target="_blank" title="Sergey Plashenko Github"><img src="/img/GitHub-Mark-32px.png" /></a>	
		
		
		
		
	</div>

	<div class="clearfix"></div>
</div>

<div class="scroll-top"><i class="fa fa-arrow-circle-up"></i></div></footer>
  

		<script type="text/javascript">
				var disqus_shortname = 'spl-tricks';

		        (function() {
		            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
		            
					var page_has_comments = ''; 

					if (page_has_comments){
						dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
						(document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
					}
				})();
		</script>

		<script type="text/javascript">
				var comments_count_enabled = 'false'; 
				
				if(comments_count_enabled === 'true') {						
					var disqus_shortname = 'spl-tricks'; 

					(function () {
						var s = document.createElement('script'); s.async = true;
						s.type = 'text/javascript';
						s.src = '//' + disqus_shortname + '.disqus.com/count.js';
						(document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
					}());
				}
		</script>

  


<!--link href="https://opensource.keycdn.com/fontawesome/4.6.3/font-awesome.min.css" rel="stylesheet"-->
<script src="https://ajax.aspnetcdn.com/ajax/jQuery/jquery-1.11.1.min.js"></script>



<!-- <script src="//cdnjs.cloudflare.com/ajax/libs/jquery.imagesloaded/3.0.4/jquery.imagesloaded.js"></script> -->
<!-- <script src="/js/gallery.js"></script> -->



<script type="text/javascript">
$(window).scroll(function() {

    if($(this).scrollTop() > 400) {
        $('.scroll-top').fadeIn(200);
    } else {
        $('.scroll-top').fadeOut(200);
    }
});

$('.scroll-top').bind('click', function(e) {
    e.preventDefault();
    $('body,html').animate({scrollTop:0},200);
});
</script>


</body>
</html>
