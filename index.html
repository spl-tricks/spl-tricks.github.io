<!DOCTYPE HTML>

<html lang="en">
  
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="utf-8">
  
  <title>SPL Advanced Tricks</title>
  <meta name="author" content="Sergey Plashenko">
  
  <meta name="description" content="Personal blog about my findings and investigations in Sitecore and not only.">
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  
  <meta property="og:site_name" content="SPL Advanced Tricks">

  
    <meta property="og:image" content>
  

  
    <meta http-equiv="Content-Language" content="en">
  

  <link href="/img/favicon.png" rel="icon">
  
    <link rel="apple-touch-icon" href="/img/apple-icon.png">
    <link rel="apple-touch-icon-precomposed" href="/img/apple-icon.png">
    

  <link rel="alternate" href="/atom.xml" title="SPL Advanced Tricks" type="application/atom+xml">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
  
  <style type="text/css">
  /* Tim Pietrusky advanced checkbox hack (Android <= 4.1.2) */
body{ -webkit-animation: bugfix infinite 1s; }
@-webkit-keyframes bugfix { from {padding:0;} to {padding:0;} }

  

  
    article .post-content-index .entry{max-height: 550px; overflow:hidden;}
  
</style>

  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->

  <!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-144711500-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-144711500-1');
</script>




  
  
</head>
</html>

<body>
  <header id="header" class="inner"><div class="padding">
	<div class="alignleft logo">
	  <h1><a href="/">SPL Advanced Tricks</a></h1>
	</div>
	<nav id="main-nav" class="alignright">
		<input type="checkbox" id="toggle" />
		<label for="toggle" class="toggle" data-open="Main Menu" data-close="Close Menu" onclick><i class="fa fa-bars"></i></label>
	  <ul class="menu">
	    
	      <li><a href="/">Home</a></li>
	    
	      <li><a href="/archives">Archives</a></li>
	    
	    
	  </ul>
	</nav>
	<div class="clearfix"></div>
</div>
</header>
  <div id="page-heading-wrap">
    <div class="inner">
      <div class="padding">
        
          <h2>
            <script>
              document.getElementById("page-heading-wrap").style.padding = 0;
            </script>
          </h2>
        
      </div>
    </div>
  </div>
  <div id="content" class="inner">
    <div id="main-col" class="alignleft"><div id="wrapper" class="padding">
  <article class="post">
  
  
    <div class="post-content-index">
  
      
        <header>
          <!-- <div class="icon"></div> -->
            
    
      <h1 class="metro-title transition"><a href="/2019/07/22/MarketingAutomationLogging/">How to inject logging to Marketing Automation condition</a></h1>
    
  
          <ul>
            <li>
              <span class="heading-span">Posted on: </span>
              <time datetime="2019-07-22T20:31:00.000Z">2019-07-22</time>
            </li>
            
              <li>
                <span class="heading-span">By: </span>

                
                  <a href="/">Sergey Plashenko</a>
                

              </li>
            
            <li>
              <!--span class="heading-span">With: </span-->
              
          </ul>
        </header>
      
      <div class="entry">
        
          
            <p>The best way to understand why something does not work is debugging it. Unfortunately, it is not always possible to attach VS or windbg to a running process. In such cases, I usually extend the code with logging and check the output. </p>
<p><br></p>
<p>Some time ago I had issues with non-working Marketing Automation condition. This was custom condition and I had code for it. After some time monitoring the MA pool without success, I decided to inject logging into the condition Evaluate method and to troubleshoot this. The conditions are processed by maengine service, thus usual Sitecore Log.Info() call won’t work here since there is no Sitecore.Kernel assembly.  Passing the ILogger via condition constructor won’t work either since the conditions are created using Activator and require parameter-less constructor.  </p>
<p><br></p>
<p>MA has quite elegant extension points, which allow us to get the ILogger from condition. The Evaluate method gets IRuleExecutionContext as a parameter, the interface has only one method Fact which is used for getting contact, interaction and other information. We will use it to get the needed ILogger implementation. I will use test FirstNameCondition further to demonstrate the behavior.  </p>
<p><br></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">using Serilog;</span><br><span class="line">using Sitecore.Framework.Rules;</span><br><span class="line">using Sitecore.XConnect;</span><br><span class="line">using Sitecore.XConnect.Collection.Model;</span><br><span class="line"></span><br><span class="line">namespace TestCondition</span><br><span class="line">&#123;</span><br><span class="line">    public class FirstNameCondition : ICondition</span><br><span class="line">    &#123;</span><br><span class="line">        public bool Evaluate(IRuleExecutionContext context)</span><br><span class="line">        &#123;</span><br><span class="line">        	var logger = context.Fact&lt;ILogger&gt;();</span><br><span class="line">            logger.Information(&quot;Condition was executed&quot;);</span><br><span class="line">            var contact = context.Fact&lt;Contact&gt;();</span><br><span class="line">            return contact.Personal()?.FirstName == &quot;Sergey&quot;;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><br></p>
<p>By default, the ILogger object is not present in context and we need to register it. It can be done by overriding the PopulateScopedFacts method of the ConditionEvaluationService.  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">public class ConditionEvaluationService : Sitecore.Xdb.MarketingAutomation.Rules.ConditionEvaluationService</span><br><span class="line">&#123;</span><br><span class="line">    private readonly ILogger&lt;Sitecore.Xdb.MarketingAutomation.Rules.ConditionEvaluationService&gt; _logger;</span><br><span class="line"></span><br><span class="line">    public ConditionEvaluationService(</span><br><span class="line">        ILogger&lt;Sitecore.Xdb.MarketingAutomation.Rules.ConditionEvaluationService&gt; logger,</span><br><span class="line">        IConditionSerializer serializer, IServiceProvider serviceProvider) : base(logger, serializer,</span><br><span class="line">        serviceProvider)</span><br><span class="line">    &#123;</span><br><span class="line">        _logger = logger;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public ConditionEvaluationService(</span><br><span class="line">        ILogger&lt;Sitecore.Xdb.MarketingAutomation.Rules.ConditionEvaluationService&gt; logger,</span><br><span class="line">        IConditionSerializer serializer, IConditionCache cache, IServiceProvider serviceProvider) : base(logger,</span><br><span class="line">        serializer, cache, serviceProvider)</span><br><span class="line">    &#123;</span><br><span class="line">        _logger = logger;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    protected override void PopulateScopedFacts(FactSpecificier facts, IContactProcessingContext processingContext,</span><br><span class="line">        IConditionServices conditionServices, ISegmentationServiceContext segmentationServiceContext)</span><br><span class="line">    &#123;</span><br><span class="line">        base.PopulateScopedFacts(facts, processingContext, conditionServices, segmentationServiceContext);</span><br><span class="line">        facts.Fact&lt;ILogger&gt;(_logger);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><br></p>
<p>The corresponding service must be replaced by a custom one in the following file:  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">App_data\jobs\continuous\AutomationEngine\App_Data\Config\sitecore\MarketingAutomation\sc.MarketingAutomation.ConditionEvaluationService.xml</span><br></pre></td></tr></table></figure>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">MarketingAutomation.Rules.ConditionEvaluationService</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">Type</span>&gt;</span>CustomNamespace.ConditionEvaluationService, CustomAssembly<span class="tag">&lt;/<span class="name">Type</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">As</span>&gt;</span>Sitecore.Xdb.MarketingAutomation.Core.Rules.IConditionEvaluationService, Sitecore.Xdb.MarketingAutomation.Core<span class="tag">&lt;/<span class="name">As</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">LifeTime</span>&gt;</span>Singleton<span class="tag">&lt;/<span class="name">LifeTime</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">MarketingAutomation.Rules.ConditionEvaluationService</span>&gt;</span></span><br></pre></td></tr></table></figure>

          
        
      </div>
      <footer>
        
          <div class="alignright">
            <a href="/2019/07/22/MarketingAutomationLogging/#more" class="more-link">Continue Reading<i class="fa fa-long-arrow-right fa-1"></i></a>
          </div>
        
        <div class="clearfix"></div>
      </footer>
    </div>
</article>





<nav id="pagination">
  
  
  <div class="clearfix"></div>
</nav></div></div>
    <aside id="sidebar" class="alignright"><div class="padding">
	
	  <div class="search">
  <form action="//google.com/search" method="get" accept-charset="utf-8">
    <input type="search" name="q" results="0" placeholder="Search">
    <input type="hidden" name="q" value="site:spl-tricks.github.io">
  </form>
</div>
	
	  
<div class="widget recent-post">
  <h3 class="title">Recent Posts</h3>
  <ul class="entry">
    
      <li>
        <a href="/2019/07/22/MarketingAutomationLogging/">How to inject logging to Marketing Automation condition</a>
      </li>
    
  </ul>
</div>

	
	  
	
	  
<div class="widget tag">
  <h3 class="title">Tags</h3>
  
    <a href="/tags/Marketing-Automation/">Marketing Automation<small>1</small></a>
  
    <a href="/tags/Sitecore/">Sitecore<small>1</small></a>
  
    <a href="/tags/xConnect/">xConnect<small>1</small></a>
  
    <a href="/tags/xDB/">xDB<small>1</small></a>
  
</div>

	
</div></aside>
    <div class="clearfix"></div>
  </div>
  <footer id="footer" class="inner"><div class="padding">
	<div class="alignleft">
	  
	  &copy; 2019 Sergey Plashenko
	  
	  <p>Powerd by <a href="http://hexo.io/" target="_blank">hexo</a>
	  and theme is modified <a href="https://github.com/halfer53/metro-light" target="_blank">metro-light</a></p>
	</div>

	<div class="alignright">
		
		
		
		
		
		
		
	</div>

	<div class="clearfix"></div>
</div>

<div class="scroll-top"><i class="fa fa-arrow-circle-up"></i></div></footer>
  


<link href="https://opensource.keycdn.com/fontawesome/4.6.3/font-awesome.min.css" rel="stylesheet">
<script src="https://ajax.aspnetcdn.com/ajax/jQuery/jquery-1.11.1.min.js"></script>



<!-- <script src="//cdnjs.cloudflare.com/ajax/libs/jquery.imagesloaded/3.0.4/jquery.imagesloaded.js"></script> -->
<!-- <script src="/js/gallery.js"></script> -->



<script type="text/javascript">
$(window).scroll(function() {

    if($(this).scrollTop() > 400) {
        $('.scroll-top').fadeIn(200);
    } else {
        $('.scroll-top').fadeOut(200);
    }
});

$('.scroll-top').bind('click', function(e) {
    e.preventDefault();
    $('body,html').animate({scrollTop:0},200);
});
</script>


</body>
</html>
